version: 2

models:
  - name: dim_orders
    description: |
      Order header attributes (one row per order_id). Includes customer_id,
      is_first_order, and order_rank_for_customer.

    columns:
      - name: order_sk
        description: "Surrogate key for the order (md5 of order_id)."
        tests: [not_null, unique]

      - name: order_id
        description: "Source order ID."
        tests: [not_null, unique]

      - name: customer_id
        description: "Customer identifier from source; may be null historically."

      - name: created_at_local
        description: "Local timestamp."

      - name: created_at_utc
        description: "UTC timestamp."

      - name: order_date_local
        description: "Date part of created_at_local."

      - name: is_first_order
        description: "True if this is the customerâ€™s first order (rank = 1)."

      - name: order_rank_for_customer
        description: "1-based sequence number per customer."

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns: ['customer_id','order_rank_for_customer']

      - dbt_utils.expression_is_true:
          arguments:
            expression: "(is_first_order = (order_rank_for_customer = 1))"
